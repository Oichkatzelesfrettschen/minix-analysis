version: '3.9'

services:
  # NetBSD i386 build environment with QEMU
  netbsd-builder:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NETBSD_VERSION=10.1
        - NETBSD_ARCH=i386
        - USER_UID=1000
        - USER_GID=1000
    
    image: minix-analysis/netbsd-i386:latest
    container_name: minix-netbsd-builder
    hostname: netbsd-builder
    
    # Privileged mode for KVM acceleration
    privileged: true
    
    # Device access
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/net/tun:/dev/net/tun
    
    # Capabilities for QEMU and networking
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
      - SYS_RESOURCE
    
    # Environment variables
    environment:
      - NETBSD_VERSION=10.1
      - NETBSD_ARCH=i386
      - QEMU_ENABLE_KVM=1
      - QEMU_MEMORY=2048
      - QEMU_CPUS=4
      - MINIX_SOURCE=/workspace/minix-source
      - BUILD_OUTPUT=/builds
      - ARTIFACTS_DIR=/artifacts
      - USER_ID=1000
      - USER_NAME=developer
      - TZ=UTC
    
    # Volume mounts
    volumes:
      # Workspace (source code)
      - ..:/workspace:cached
      
      # Persistent VM images
      - netbsd-vm-images:/vm/images
      
      # Build outputs
      - netbsd-builds:/builds
      
      # MINIX artifacts
      - minix-artifacts:/artifacts
      
      # Shared cache for downloads
      - netbsd-cache:/var/cache/netbsd
      
      # SSH keys (if needed)
      - ${HOME}/.ssh:/home/developer/.ssh:ro
    
    # Port mapping
    ports:
      # VNC for NetBSD VM
      - "5900:5900"
      
      # SSH to NetBSD VM
      - "2222:2222"
      
      # QEMU monitor
      - "55555:55555"
      
      # Analysis dashboard
      - "8080:8080"
      
      # Additional serial ports
      - "9001:9001"
    
    # Network configuration
    networks:
      - netbsd-net
    
    # Working directory
    working_dir: /workspace
    
    # Keep container running
    command: sleep infinity
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    # Health check
    healthcheck:
      test: ["CMD", "qemu-system-i386", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Named volumes
volumes:
  netbsd-vm-images:
    driver: local
  netbsd-builds:
    driver: local
  minix-artifacts:
    driver: local
  netbsd-cache:
    driver: local

# Networks
networks:
  netbsd-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16
          gateway: 172.31.0.1
