version: '3.9'

# Enhanced MINIX Analysis Docker Compose
# Includes MCP servers for Docker, Docker Hub, and GitHub integration
# Supports i386 and ARM MINIX instances with boot profiling and error diagnosis

services:
  # ============================================================================
  # MCP SERVERS (Model Context Protocol - for Claude Code integration)
  # ============================================================================

  # Docker MCP Server - Control containers, get logs, monitor stats
  docker-mcp:
    image: quantgeekdev/docker-mcp:latest
    container_name: mcp-docker
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - MCP_PORT=5000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - minix-analysis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Docker Hub MCP Server - Search images, manage repositories
  docker-hub-mcp:
    image: docker:24-dind
    container_name: mcp-docker-hub
    restart: unless-stopped
    ports:
      - "5001:5000"
    environment:
      - DOCKER_HUB_USERNAME=${DOCKER_HUB_USERNAME:-}
      - DOCKER_HUB_TOKEN=${DOCKER_HUB_TOKEN:-}
      - MCP_PORT=5000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - minix-analysis
    depends_on:
      - docker-mcp

  # GitHub MCP Server - Manage repo, PRs, issues
  github-mcp:
    image: node:20-alpine
    container_name: mcp-github
    restart: unless-stopped
    ports:
      - "5002:5000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - MCP_PORT=5000
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        npm install -g @github/cli-mcp-server 2>/dev/null || true &&
        node -e 'require(\"@github/cli-mcp-server\")' ||
        echo 'GitHub MCP installed'
      "
    networks:
      - minix-analysis

  # ============================================================================
  # MINIX INSTANCES
  # ============================================================================

  # i386 MINIX instance with QEMU and KVM
  minix-i386:
    build:
      context: ./docker
      dockerfile: Dockerfile.i386
    container_name: minix-rc6-i386
    privileged: true
    devices:
      - /dev/kvm:/dev/kvm
    ports:
      - "5900:5900"  # VNC display
      - "2222:2222"  # SSH access
      - "9000:9000"  # Analysis metrics port
    volumes:
      - ./docker:/minix-runtime
      - ./measurements/i386:/measurements
      - ./data:/data
    environment:
      - DISPLAY=:0
      - QEMU_CPU=host
      - BOOT_TIMEOUT=300
      - SERIAL_LOG=/measurements/boot.log
      - MINIX_CONSOLE=tty00
      - MINIX_CONSDEV=com0
      - MINIX_MEMORY=512M
      - MINIX_CPUS=1
      - MINIX_ISO=/minix-runtime/minix_R3.4.0rc6-d5e4fc0.iso
    networks:
      - minix-analysis
    healthcheck:
      test: ["CMD", "test", "-f", "/measurements/boot.log"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: no
    depends_on:
      - docker-mcp

  # ARM MINIX instance (requires ARM MINIX artifacts)
  minix-arm:
    build:
      context: ./docker
      dockerfile: Dockerfile.arm
    container_name: minix-rc6-arm
    privileged: true
    devices:
      - /dev/kvm:/dev/kvm
    ports:
      - "5901:5900"  # VNC display (offset)
      - "2223:2222"  # SSH access (offset)
      - "9001:9000"  # Analysis metrics port (offset)
    volumes:
      - ./docker:/minix-runtime
      - ./measurements/arm:/measurements
      - ./data:/data
    environment:
      - DISPLAY=:0
      - QEMU_CPU=host
      - BOOT_TIMEOUT=300
      - SERIAL_LOG=/measurements/boot.log
      - MINIX_CONSOLE=tty00
      - MINIX_CONSDEV=com0
      - MINIX_MEMORY=512M
      - MINIX_CPUS=1
    networks:
      - minix-analysis
    depends_on:
      - minix-i386
    healthcheck:
      test: ["CMD", "test", "-f", "/measurements/boot.log"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: no

  # ============================================================================
  # ANALYSIS SERVICES (Boot profiler, syscall tracer, memory monitor)
  # ============================================================================

  # MCP Boot Profiler server
  mcp-boot-profiler:
    build:
      context: ./mcp-servers/boot-profiler
      dockerfile: Dockerfile
    container_name: mcp-boot-profiler
    restart: unless-stopped
    ports:
      - "5010:5000"
    volumes:
      - ./measurements:/measurements
      - ./data:/data
      - ./logs:/logs
    networks:
      - minix-analysis
    depends_on:
      - minix-i386
      - docker-mcp
    environment:
      - MINIX_I386_CONTAINER=minix-rc6-i386
      - MINIX_ARM_CONTAINER=minix-rc6-arm
      - MEASUREMENTS_DIR=/measurements
      - LOG_DIR=/logs
      - BOOT_TIMEOUT=300
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Syscall Tracer server
  mcp-syscall-tracer:
    build:
      context: ./mcp-servers/syscall-tracer
      dockerfile: Dockerfile
    container_name: mcp-syscall-tracer
    restart: unless-stopped
    ports:
      - "5011:5000"
    volumes:
      - ./measurements:/measurements
      - ./data:/data
      - ./logs:/logs
    networks:
      - minix-analysis
    depends_on:
      - minix-i386
      - docker-mcp
    environment:
      - MINIX_I386_CONTAINER=minix-rc6-i386
      - MEASUREMENTS_DIR=/measurements
      - LOG_DIR=/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Memory Monitor server
  mcp-memory-monitor:
    build:
      context: ./mcp-servers/memory-monitor
      dockerfile: Dockerfile
    container_name: mcp-memory-monitor
    restart: unless-stopped
    ports:
      - "5012:5000"
    volumes:
      - ./measurements:/measurements
      - ./data:/data
      - ./logs:/logs
    networks:
      - minix-analysis
    depends_on:
      - minix-i386
      - docker-mcp
    environment:
      - MINIX_I386_CONTAINER=minix-rc6-i386
      - MEASUREMENTS_DIR=/measurements
      - LOG_DIR=/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # DIAGNOSTIC AND UTILITY SERVICES
  # ============================================================================

  # Error diagnosis and recovery service
  error-diagnostics:
    image: python:3.11-slim
    container_name: minix-error-diagnostics
    restart: no
    volumes:
      - ./:/workspace
      - ./logs:/logs
      - ./measurements:/measurements
      - ./data:/data
    working_dir: /workspace
    command: >
      sh -c "
        pip install -q pyyaml jsonschema &&
        python3 tools/triage-minix-errors.py
      "
    networks:
      - minix-analysis
    depends_on:
      - minix-i386

  # Boot parameter validation service
  boot-validator:
    image: bash:5.2
    container_name: minix-boot-validator
    restart: no
    volumes:
      - ./:/workspace
      - ./docker:/docker-config
      - ./scripts:/scripts
    working_dir: /workspace
    command: bash ./scripts/minix-boot-diagnostics.sh
    networks:
      - minix-analysis

  # ============================================================================
  # OBSERVABILITY
  # ============================================================================

  # Prometheus for metrics collection (optional, for monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - minix-analysis

  # ============================================================================
  # NETWORKS AND VOLUMES
  # ============================================================================

networks:
  minix-analysis:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  minix-i386-data:
    driver: local
  minix-arm-data:
    driver: local
  measurements-data:
    driver: local
  prometheus_data:
    driver: local
